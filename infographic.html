<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Timeline + Body Map - Gorilla HIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Enhanced timeline styles */
    .timeline-container {
      position: relative;
      min-height: 140px;
      padding: 20px 0;
    }
    
    .timeline-line { 
      height: 8px; 
      background: linear-gradient(90deg, #e2e8f0, #cbd5e1, #e2e8f0); 
      position: relative; 
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .event-marker { 
      width: 48px; 
      height: 48px; 
      border-radius: 50%; 
      position: absolute; 
      transform: translate(-50%, -50%); 
      top: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 20px; 
      color: white; 
      cursor: pointer; 
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      border: 3px solid white;
    }
    
    .event-marker:hover {
      transform: translate(-50%, -50%) scale(1.1);
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
    }
    
    .event-label { 
      position: absolute; 
      transform: translate(-50%, 0); 
      width: 200px;
      z-index: 10;
    }
    
    .lane { 
      min-height: 160px; 
      margin-bottom: 24px;
    }
    
    .card-shadow { 
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.8);
    }

    /* Improved label positioning */
    .label-top { 
      top: -85px; 
    }
    .label-bottom { 
      bottom: -85px; 
    }

    /* Better spacing for labels */
    .event-label-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      border: 1px solid #e2e8f0;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .event-label-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.18);
      transform: translateY(-2px);
    }

    /* Connected line from marker to label */
    .label-connector {
      position: absolute;
      width: 2px;
      background: #cbd5e1;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .label-top .label-connector {
      top: 100%;
      height: 20px;
    }
    
    .label-bottom .label-connector {
      bottom: 100%;
      height: 20px;
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .event-label { 
        width: 160px; 
      }
      .event-marker { 
        width: 40px; 
        height: 40px; 
        font-size: 16px;
      }
      .timeline-container {
        min-height: 120px;
        padding: 15px 0;
      }
      .lane {
        min-height: 140px;
      }
    }

    /* Enhanced patient info cards */
    .info-card {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      transition: all 0.3s ease;
    }
    
    .info-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    }

    /* Disease badge improvements */
    .disease-badge {
      transition: all 0.3s ease;
    }
    
    .disease-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Timeline endpoints */
    .timeline-start {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #10b981;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      border: 2px solid white;
    }

    .timeline-current {
      position: absolute;
      right: 120px;
      top: 50%;
      transform: translateY(-50%);
      background: #3b82f6;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      border: 2px solid white;
      animation: pulse 2s infinite;
    }

    .timeline-target {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #22c55e;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      border: 2px solid white;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Progress fill */
    .timeline-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: 8px;
      opacity: 0.3;
      transition: all 0.5s ease;
    }

    /* Better organ buttons */
    .organ-button {
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .organ-button:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <div class="max-w-7xl mx-auto p-4 lg:p-6">
    <!-- Header / Patient snapshot -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start mb-6">
      <div class="lg:col-span-4 bg-white rounded-xl p-6 card-shadow info-card">
        <div class="flex items-center gap-4">
          <img src="https://api.dicebear.com/6.x/initials/svg?seed=Somjai" class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 p-2 border-4 border-white shadow-lg" alt="avatar">
          <div class="flex-1">
            <div class="text-xl font-bold text-slate-800">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏™‡∏°‡πÉ‡∏à  ‡πÉ‡∏à‡∏î‡∏µ</div>
            <div class="text-sm text-slate-500 mt-1">‡∏´‡∏ç‡∏¥‡∏á (Female) ‚Ä¢ DOB: 01 Jan 1979</div>
            <div class="text-sm text-slate-500">HN: 01-25-00360</div>
            <div class="mt-3 flex flex-wrap gap-2">
              <span class="inline-block px-3 py-1 rounded-full text-xs bg-indigo-100 text-indigo-700 font-medium">BloodGroup: N/A</span>
              <span class="inline-block px-3 py-1 rounded-full text-xs bg-slate-100 text-slate-600 font-medium">Allergy: -</span>
            </div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-2 gap-3">
          <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
            <div class="text-xs text-blue-600 font-medium">Weight</div>
            <div class="font-bold text-lg text-blue-800">51.2 kg</div>
          </div>
          <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
            <div class="text-xs text-green-600 font-medium">BMI</div>
            <div class="font-bold text-lg text-green-800">20.0</div>
          </div>
          <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
            <div class="text-xs text-purple-600 font-medium">BP</div>
            <div class="font-bold text-lg text-purple-800">100 / 80</div>
          </div>
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
            <div class="text-xs text-orange-600 font-medium">Pulse</div>
            <div class="font-bold text-lg text-orange-800">60</div>
          </div>
        </div>

        <div class="mt-6">
          <div class="text-sm text-slate-600 font-medium mb-3">‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å</div>
          <div class="flex flex-wrap gap-2">
            <span class="disease-badge px-4 py-2 rounded-full text-sm bg-blue-100 text-blue-800 font-medium">üíô ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (DM2)</span>
            <span class="disease-badge px-4 py-2 rounded-full text-sm bg-red-100 text-red-800 font-medium">‚ù§Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (HT)</span>
            <span class="disease-badge px-4 py-2 rounded-full text-sm bg-yellow-100 text-yellow-800 font-medium">üü† ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (HLD)</span>
          </div>
        </div>
      </div>

      <!-- Body map center -->
      <div class="lg:col-span-4 bg-white rounded-xl p-6 card-shadow info-card flex flex-col items-center">
        <div class="text-sm text-slate-600 font-medium mb-1">Tap icon to view organ details</div>
        <div class="relative w-full mt-4" style="max-width:380px">
          <!-- simplified body map (SVG placeholder) -->
         
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <img src="images/body.png" alt="body" class="w-full opacity-90 rounded-lg">

          <!-- sample organ icons absolute positioned -->
          <button class="organ-button absolute left-1/2 top-[34%] -translate-x-1/2 bg-red-500 text-white rounded-full p-3 shadow-lg" data-organ="lung">ü´Å</button>
          <button class="organ-button absolute left-[38%] top-[56%] bg-yellow-500 text-white rounded-full p-3 shadow-lg" data-organ="liver">üçñ</button>
          <button class="organ-button absolute right-[36%] top-[64%] bg-amber-600 text-white rounded-full p-3 shadow-lg" data-organ="kidney">ü´ô</button>
          <button class="organ-button absolute left-[46%] top-[78%] bg-sky-500 text-white rounded-full p-3 shadow-lg" data-organ="knees">ü¶µ</button>
        </div>

        <div id="organPanel" class="mt-6 w-full hidden">
          <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-4 rounded-lg border border-slate-200">
            <div id="organTitle" class="font-bold text-lg text-slate-800">Chest</div>
            <div id="organDesc" class="text-sm text-slate-600 mt-2">Impression: No active chest disease</div>
          </div>
        </div>
      </div>

      <!-- Right panel: labs/imaging -->
      <div class="lg:col-span-4 bg-white rounded-xl p-6 card-shadow info-card">
        <div class="space-y-6">
          <div>
            <div class="flex items-center justify-between mb-4">
              <div class="font-bold text-lg text-slate-800">Latest Labs</div>
              <div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Updated: 2024-05-01</div>
            </div>
            <div class="space-y-3">
              <div class="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg flex items-center justify-between">
                <div class="text-sm text-red-700 font-medium">HbA1c</div>
                <div class="font-bold text-red-800 text-lg">6.8%</div>
              </div>
              <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg flex items-center justify-between">
                <div class="text-sm text-yellow-700 font-medium">LDL</div>
                <div class="font-bold text-yellow-800 text-lg">110 mg/dL</div>
              </div>
              <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg flex items-center justify-between">
                <div class="text-sm text-green-700 font-medium">ALT</div>
                <div class="font-bold text-green-800 text-lg">20 U/L</div>
              </div>
            </div>
          </div>

          <div>
            <div class="font-bold text-lg text-slate-800 mb-4">Chest X-ray</div>
            <div class="flex gap-4">
              <img src="https://i.ibb.co/9r1P7JQ/chest-sample.jpg" class="w-20 h-20 object-cover rounded-lg border-2 border-slate-200 shadow-md" alt="chest">
              <div class="flex-1 bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                <div class="text-sm text-blue-700 font-medium">Impression</div>
                <div class="font-bold text-blue-800 mt-1">No active chest disease</div>
              </div>
            </div>
          </div>

          <div>
            <div class="font-bold text-lg text-slate-800 mb-4">HbA1c Trend</div>
            <div class="bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg p-4 border border-slate-200">
              <canvas id="chartHbA1c" height="80" class="w-full"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline area -->
    <section class="bg-white rounded-xl p-6 card-shadow info-card">
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-bold text-2xl text-slate-800">Patient Timeline (Disease Journey)</h2>
        <div class="text-sm text-slate-500 bg-slate-100 px-3 py-2 rounded-full font-medium">Start ‚Ä¢ Events ‚Ä¢ Current ‚Ä¢ Target</div>
      </div>

      <div class="space-y-8">
        <!-- Each disease lane -->
        <div class="lane bg-gradient-to-r from-blue-50/50 to-blue-100/50 rounded-xl p-6 border border-blue-200/50">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-4 h-4 rounded-full bg-blue-500 shadow-md"></div>
              <div>
                <div class="font-bold text-lg text-slate-800">‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏ä‡∏ô‡∏¥‡∏î‡∏ó‡∏µ‡πà 2 (DM2)</div>
                <div class="text-sm text-blue-600 font-medium">Goal: HbA1c &lt; 7%</div>
              </div>
            </div>
            <div class="text-sm text-slate-600 bg-white px-3 py-2 rounded-lg font-medium shadow-sm">
              Diagnosis: 2019-03 ‚Ä¢ Last: 2024-05
            </div>
          </div>

          <div class="timeline-container relative">
            <div class="timeline-line"></div>
            <div class="target-indicator">
              <div class="text-xs text-green-600 font-medium">Target</div>
              <div class="font-bold text-green-700">HbA1c &lt; 7%</div>
            </div>
          </div>
        </div>

        <div class="lane bg-gradient-to-r from-red-50/50 to-red-100/50 rounded-xl p-6 border border-red-200/50">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-4 h-4 rounded-full bg-red-500 shadow-md"></div>
              <div>
                <div class="font-bold text-lg text-slate-800">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á (HT)</div>
                <div class="text-sm text-red-600 font-medium">Goal: BP &lt; 130/80</div>
              </div>
            </div>
            <div class="text-sm text-slate-600 bg-white px-3 py-2 rounded-lg font-medium shadow-sm">
              Diagnosis: 2021-08 ‚Ä¢ Last: 2023-11
            </div>
          </div>

          <div class="timeline-container relative">
            <div class="timeline-line"></div>
            <div class="target-indicator">
              <div class="text-xs text-green-600 font-medium">Target</div>
              <div class="font-bold text-green-700">BP &lt; 130/80</div>
            </div>
          </div>
        </div>

        <div class="lane bg-gradient-to-r from-amber-50/50 to-amber-100/50 rounded-xl p-6 border border-amber-200/50">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-4 h-4 rounded-full bg-amber-500 shadow-md"></div>
              <div>
                <div class="font-bold text-lg text-slate-800">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á (HLD)</div>
                <div class="text-sm text-amber-600 font-medium">Goal: LDL &lt; 100 mg/dL</div>
              </div>
            </div>
            <div class="text-sm text-slate-600 bg-white px-3 py-2 rounded-lg font-medium shadow-sm">
              Diagnosis: 2023-02 ‚Ä¢ Last: 2024-04
            </div>
          </div>

          <div class="timeline-container relative">
            <div class="timeline-line"></div>
            <div class="target-indicator">
              <div class="text-xs text-green-600 font-medium">Target</div>
              <div class="font-bold text-green-700">LDL &lt; 100</div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="text-sm text-blue-700 font-medium">üí° Tip: ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Export ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå</div>
      </div>
    </section>
  </div>

  <script>
    // Enhanced patient data with better spacing logic
    const patient = {
      diseases: [
        { code:'DM2', title:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏ä‡∏ô‡∏¥‡∏î‡∏ó‡∏µ‡πà 2', color:'#3b82f6', goal:'HbA1c < 7%', events:[
          {date:'2019-03', type:'diagnosis', title:'‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', note:'HbA1c 8.2%'},
          {date:'2019-04', type:'med', title:'‡πÄ‡∏£‡∏¥‡πà‡∏° Metformin', note:'500mg BID'},
          {date:'2021-10', type:'lab', title:'HbA1c 7.4%', note:'‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô'},
          {date:'2024-05', type:'med', title:'‡πÄ‡∏£‡∏¥‡πà‡∏° SGLT2 inhibitor', note:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤'}
        ]},
        { code:'HT', title:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á', color:'#ef4444', goal:'BP < 130/80', events:[
          {date:'2021-08', type:'diagnosis', title:'‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', note:'BP 150/95'},
          {date:'2021-09', type:'med', title:'‡πÄ‡∏£‡∏¥‡πà‡∏° ACE inhibitor', note:'Perindopril 4mg'},
          {date:'2023-11', type:'check', title:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 138/86', note:'‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'}
        ]},
        { code:'HLD', title:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á', color:'#f59e0b', goal:'LDL < 100', events:[
          {date:'2023-02', type:'diagnosis', title:'‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ LDL ‡∏™‡∏π‡∏á', note:'LDL 150 mg/dL'},
          {date:'2023-03', type:'med', title:'‡πÄ‡∏£‡∏¥‡πà‡∏° Statin', note:'Atorvastatin 20mg'},
          {date:'2024-04', type:'lab', title:'LDL 110', note:'‡∏¢‡∏±‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'}
        ]}
      ]
    };

    function toMonthIndex(ym){ 
      const [y,m] = ym.split('-').map(Number); 
      return y*12 + (m-1); 
    }

    // Enhanced rendering with better label positioning
    function renderLanes(){
      const minSpacing = 15; // minimum percentage spacing between events
      
      // compute global range
      let minIdx = Infinity, maxIdx = -Infinity;
      patient.diseases.forEach(d=>d.events.forEach(e=>{ 
        const idx = toMonthIndex(e.date); 
        if(idx<minIdx) minIdx=idx; 
        if(idx>maxIdx) maxIdx=idx; 
      }));
      minIdx -= 6; maxIdx += 6; // more padding
      const span = maxIdx - minIdx + 1;

      const lanes = document.querySelectorAll('.lane');
      lanes.forEach((laneEl, laneIndex) => {
        const timelineContainer = laneEl.querySelector('.timeline-container');
        const line = timelineContainer.querySelector('.timeline-line');
        
        // clear existing markers and labels
        line.querySelectorAll('.event-marker, .event-label').forEach(n=>n.remove());
        
        const disease = patient.diseases[laneIndex];
        let usedPositions = []; // track positions to avoid overlap
        
        disease.events.forEach((ev, eventIndex) => {
          let pos = ((toMonthIndex(ev.date)-minIdx)/span)*100;
          
          // Adjust position if too close to existing markers
          usedPositions.forEach(usedPos => {
            if (Math.abs(pos - usedPos) < minSpacing) {
              pos = usedPos + minSpacing;
            }
          });
          
          // Keep within bounds
          pos = Math.max(5, Math.min(85, pos));
          usedPositions.push(pos);
          
          // Create marker
          const marker = document.createElement('div');
          marker.className = 'event-marker';
          marker.style.left = pos + '%';
          marker.style.background = `linear-gradient(135deg, ${disease.color}, ${disease.color}dd)`;
          
          // Enhanced icons
          const icons = {
            'med': 'üíä', 
            'lab': 'ü©∏', 
            'diagnosis': 'üè•', 
            'check': 'üìã',
            'default': '‚ö†Ô∏è'
          };
          const icon = icons[ev.type] || icons.default;
          marker.innerHTML = `<span style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3))">${icon}</span>`;
          marker.title = `${ev.date} ‚Ä¢ ${ev.title}`;
          marker.addEventListener('click', ()=> showEventPopup(ev, disease));
          line.appendChild(marker);

          // Create enhanced label with better positioning
          const label = document.createElement('div');
          label.className = 'event-label text-sm';
          
          // Smart positioning: alternate top/bottom, but check for space
          const isTop = eventIndex % 2 === 0;
          label.classList.add(isTop ? 'label-top' : 'label-bottom');
          label.style.left = pos + '%';
          
          label.innerHTML = `
            <div class="label-connector"></div>
            <div class="event-label-card">
              <div class="font-bold text-sm text-slate-800" style="color: ${disease.color}">${ev.date}</div>
              <div class="font-medium text-sm text-slate-700 mt-1">${ev.title}</div>
              ${ev.note ? `<div class="text-xs text-slate-500 mt-2">${ev.note}</div>` : ''}
            </div>
          `;
          timelineContainer.appendChild(label);
        });
      });
    }

    function showEventPopup(ev, disease){
      // Enhanced popup with better formatting
      const popup = `
üè• ${disease.title}

üìÖ ${ev.date} - ${ev.title}

${ev.note ? 'üìù ' + ev.note : ''}

üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${disease.goal}
      `.trim();
      
      alert(popup);
    }

    // Enhanced organ panel interaction
    document.querySelectorAll('[data-organ]').forEach(btn=> btn.addEventListener('click', (e)=>{
      const organ = e.currentTarget.getAttribute('data-organ');
      const panel = document.getElementById('organPanel');
      const organData = {
        'lung': { title: 'Chest & Lungs', desc: 'Impression: Clear lung fields, no active disease' },
        'liver': { title: 'Liver', desc: 'Impression: Normal liver function, no fatty infiltration' },
        'kidney': { title: 'Kidneys', desc: 'Impression: Normal kidney function, GFR > 60' },
        'knees': { title: 'Knees & Joints', desc: 'Impression: No significant joint abnormalities' }
      };
      
      const data = organData[organ] || { title: organ, desc: 'No data available' };
      document.getElementById('organTitle').textContent = data.title;
      document.getElementById('organDesc').textContent = data.desc;
      panel.classList.remove('hidden');
      panel.scrollIntoView({behavior:'smooth', block:'center'});
      
      // Add visual feedback
      e.currentTarget.style.transform = 'scale(1.2)';
      setTimeout(() => {
        e.currentTarget.style.transform = '';
      }, 200);
    }));

    // Enhanced chart rendering
    function drawChart(){
      const canvas = document.getElementById('chartHbA1c');
      if(!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const values = [8.2, 7.6, 7.4, 6.8];
      const labels = ['2019', '2021', '2022', '2024'];
      const targetLine = 7.0;
      
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = 80 * dpr;
      ctx.scale(dpr, dpr);
      
      const w = rect.width;
      const h = 80;
      const padding = 40;
      const chartW = w - padding * 2;
      const chartH = h - padding;
      
      ctx.clearRect(0, 0, w, h);
      
      // Scale
      const maxVal = Math.max(...values, targetLine) + 0.5;
      const minVal = Math.min(...values, targetLine) - 0.5;
      const valRange = maxVal - minVal;
      
      // Draw target line
      const targetY = padding + chartH - ((targetLine - minVal) / valRange) * chartH;
      ctx.beginPath();
      ctx.setLineDash([5, 5]);
      ctx.moveTo(padding, targetY);
      ctx.lineTo(w - padding, targetY);
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Draw value line
      ctx.beginPath();
      const stepX = chartW / (values.length - 1);
      
      values.forEach((val, i) => {
        const x = padding + i * stepX;
        const y = padding + chartH - ((val - minVal) / valRange) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 3;
      ctx.stroke();
      
      // Draw points and labels
      ctx.fillStyle = '#3b82f6';
      ctx.font = '12px Inter';
      ctx.textAlign = 'center';
      
      values.forEach((val, i) => {
        const x = padding + i * stepX;
        const y = padding + chartH - ((val - minVal) / valRange) * chartH;
        
        // Point
        ctx.